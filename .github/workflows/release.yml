name: Release
on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  deployments: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-22.04, windows-latest]
        arch: [x64, arm64]
        exclude:
          - platform: macos-latest
            arch: x64
          - platform: macos-latest
            arch: arm64
          - platform: ubuntu-22.04
            arch: arm64
        include:
          - platform: macos-latest
            arch: universal
    runs-on: ${{ matrix.platform }}
    env:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust (Stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'windows-latest' && matrix.arch == 'arm64' && 'aarch64-pc-windows-msvc' || matrix.platform == 'macos-latest' && matrix.arch == 'universal' && 'aarch64-apple-darwin x86_64-apple-darwin' || '' }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "tauri-build-${{ matrix.platform }}-${{ matrix.arch || 'x64' }}"

      - name: Install Dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev

      - name: Install frontend dependencies
        run: npm install

      - name: Install macOS targets
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - name: Setup Windows ARM64 environment
        if: matrix.platform == 'windows-latest' && matrix.arch == 'arm64'
        run: |
          echo "RUSTFLAGS=-C target-feature=+crt-static" >> $GITHUB_ENV

      - name: Build the app (Standard x64)
        if: matrix.arch == 'x64'
        uses: tauri-apps/tauri-action@v0
        with:
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('dev-{0}', github.sha) }}
          releaseName: ${{ startsWith(github.ref, 'refs/tags/') && format('OpenFrp CPL v{0}', github.ref_name) || format('Development Build ({0})', github.sha) }}
          releaseBody: ${{ startsWith(github.ref, 'refs/tags/') && 'è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£æ›´æ–°å†…å®¹ã€‚' || format('å¼€å‘æž„å»º - æäº¤ä¿¡æ¯ï¼š{0}', github.event.head_commit.message) }}
          releaseDraft: ${{ startsWith(github.ref, 'refs/tags/') }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          includeRelease: true
          includeUpdaterJson: true

      - name: Upload x64 artifacts
        if: matrix.arch == 'x64'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}-artifacts
          path: |
            src-tauri/gen/*/metadata.json
            src-tauri/target/**/release/*.msi
            src-tauri/target/**/release/*.exe
            src-tauri/target/**/release/bundle/deb/*.deb
            src-tauri/target/**/release/bundle/appimage/*.AppImage
          if-no-files-found: warn

      - name: Build the app (WINDOWS ARM64)
        if: matrix.arch == 'arm64' && matrix.platform == 'windows-latest'
        uses: tauri-apps/tauri-action@v0
        with:
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('dev-{0}', github.sha) }}
          releaseName: ${{ startsWith(github.ref, 'refs/tags/') && format('OpenFrp CPL v{0}', github.ref_name) || format('Development Build ({0})', github.sha) }}
          releaseBody: ${{ startsWith(github.ref, 'refs/tags/') && 'è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£æ›´æ–°å†…å®¹ã€‚' || format('å¼€å‘æž„å»º - æäº¤ä¿¡æ¯ï¼š{0}', github.event.head_commit.message) }}
          releaseDraft: ${{ startsWith(github.ref, 'refs/tags/') }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          includeRelease: true
          includeUpdaterJson: true
          args: --target aarch64-pc-windows-msvc

      - name: Upload Windows ARM64 artifacts
        if: matrix.arch == 'arm64' && matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-arm64-artifacts
          path: |
            src-tauri/gen/aarch64-pc-windows-msvc/metadata.json
            src-tauri/target/aarch64-pc-windows-msvc/release/*.msi
            src-tauri/target/aarch64-pc-windows-msvc/release/*.exe
          if-no-files-found: warn

      - name: Import Apple Certificate
        if: matrix.platform == 'macos-latest'
        run: |
          echo "é…ç½®è¯ä¹¦çŽ¯å¢ƒ..."
          
          # æ¸…ç†ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§keychain
          security delete-keychain build.keychain || true
          
          # åˆ›å»ºæ–°çš„ä¸´æ—¶keychain
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security list-keychains -d user -s build.keychain login.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          
          # è®¾ç½®keychainè¶…æ—¶æ—¶é—´ï¼Œç¡®ä¿åœ¨æž„å»ºè¿‡ç¨‹ä¸­ä¸ä¼šé”å®š
          security set-keychain-settings -t 3600 -l build.keychain
    
          echo "å¯¼å…¥è¯ä¹¦..."
          echo "${{ secrets.CERTIFICATES_P12 }}" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "${{ secrets.CERTIFICATES_P12_PASSWORD }}" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
    
          echo "è®¾ç½®keychainåˆ†åŒºåˆ—è¡¨..."
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" \
            build.keychain
    
          echo "éªŒè¯è¯ä¹¦å¯¼å…¥æƒ…å†µ..."
          security find-identity -v build.keychain

      - name: Build the app (macOS universal)
        if: matrix.platform == 'macos-latest' && matrix.arch == 'universal'
        uses: tauri-apps/tauri-action@v0
        env:
          MACOSX_DEPLOYMENT_TARGET: 10.14
        with:
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('dev-{0}', github.sha) }}
          releaseName: ${{ startsWith(github.ref, 'refs/tags/') && format('OpenFrp CPL v{0}', github.ref_name) || format('Development Build ({0})', github.sha) }}
          releaseBody: ${{ startsWith(github.ref, 'refs/tags/') && 'è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£æ›´æ–°å†…å®¹ã€‚' || format('å¼€å‘æž„å»º - æäº¤ä¿¡æ¯ï¼š{0}', github.event.head_commit.message) }}
          releaseDraft: ${{ startsWith(github.ref, 'refs/tags/') }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          includeRelease: true
          includeUpdaterJson: true
          args: --target universal-apple-darwin

      - name: Upload macOS artifacts
        if: matrix.platform == 'macos-latest' && matrix.arch == 'universal'
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-artifacts
          path: |
            src-tauri/gen/universal-apple-darwin/metadata.json
            src-tauri/target/universal-apple-darwin/release/bundle/**/*.dmg
            src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app
            src-tauri/target/*.dmg
            src-tauri/target/*.zip
          if-no-files-found: warn

      - name: Re-sign with Entitlements (macOS only)
        if: matrix.platform == 'macos-latest'
        run: |
          # åº”ç”¨è·¯å¾„
          APP_PATH="/Users/runner/work/OpenFrp-CrossPlatformLauncher/OpenFrp-CrossPlatformLauncher/src-tauri/target/universal-apple-darwin/release/bundle/macos/OpenFrp-CrossPlatformLauncher.app"
          ENTITLEMENTS_PATH="$(pwd)/macos.entitlements"
          
          echo "æ£€æŸ¥entitlementsæ–‡ä»¶ï¼š"
          cat "${ENTITLEMENTS_PATH}"

          codesign --force --deep --timestamp --options runtime --entitlements "${ENTITLEMENTS_PATH}" --sign "Developer ID Application: Enjie Ye (W6D36R8RMG)" "${APP_PATH}"
          
          # éªŒè¯ç­¾å
          codesign -dvvv "${APP_PATH}"

      - name: Create and Sign DMG (macOS only)
        if: matrix.platform == 'macos-latest'
        id: create_dmg
        run: |
          echo "åˆ›å»ºDMGåŒ…..."
          # è®¾ç½®è·¯å¾„å˜é‡
          APP_PATH="/Users/runner/work/OpenFrp-CrossPlatformLauncher/OpenFrp-CrossPlatformLauncher/src-tauri/target/universal-apple-darwin/release/bundle/macos/OpenFrp-CrossPlatformLauncher.app"
          DMG_PATH="/Users/runner/work/OpenFrp-CrossPlatformLauncher/OpenFrp-CrossPlatformLauncher/src-tauri/target/OpenFrp-CrossPlatformLauncher.dmg"
          TEMP_DMG_PATH="/Users/runner/work/OpenFrp-CrossPlatformLauncher/OpenFrp-CrossPlatformLauncher/src-tauri/target/temp.dmg"
          
          # ç¡®ä¿åº”ç”¨å·²ç­¾å
          echo "æ£€æŸ¥åº”ç”¨ç­¾åçŠ¶æ€..."
          codesign -dvv "${APP_PATH}" || echo "åº”ç”¨å¯èƒ½æœªæ­£ç¡®ç­¾åï¼Œä½†ä¼šç»§ç»­å°è¯•"
          
          # æ£€æŸ¥ç›®æ ‡è·¯å¾„æ˜¯å¦å­˜åœ¨
          [ -d "${APP_PATH}" ] || { echo "åº”ç”¨ä¸å­˜åœ¨äºŽè·¯å¾„: ${APP_PATH}"; exit 1; }
          
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶
          echo "æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§DMGæ–‡ä»¶..."
          rm -f "${DMG_PATH}" "${TEMP_DMG_PATH}"
          
          # ç­‰å¾…ä¸€ä¼šå„¿ç¡®ä¿èµ„æºé‡Šæ”¾
          sleep 3
          
          # å°è¯•ç›´æŽ¥åˆ›å»ºDMGï¼Œè·³è¿‡ä¸´æ—¶DMGæ­¥éª¤
          echo "ç›´æŽ¥åˆ›å»ºDMG..."
          if ! hdiutil create -volname "OpenFrp-CPL" -srcfolder "${APP_PATH}" -ov -format UDZO "${DMG_PATH}"; then
            echo "ç›´æŽ¥åˆ›å»ºDMGå¤±è´¥ï¼Œå°è¯•åˆ›å»ºZIPåŒ…ä½œä¸ºå¤‡é€‰..."
            ZIP_PATH="/Users/runner/work/OpenFrp-CrossPlatformLauncher/OpenFrp-CrossPlatformLauncher/src-tauri/target/OpenFrp-CrossPlatformLauncher.zip"
            ditto -c -k --keepParent "${APP_PATH}" "${ZIP_PATH}"
            echo "zip_path=${ZIP_PATH}" >> $GITHUB_OUTPUT
            echo "dmg_path=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ˜¾ç¤ºè¯ä¹¦ä¿¡æ¯è¿›è¡Œè°ƒè¯•
          echo "å¯ç”¨è¯ä¹¦ä¿¡æ¯ï¼š"
          security find-identity -v build.keychain
          
          # å°è¯•ç­¾åDMG
          echo "ç­¾åDMG..."
          codesign --force --sign "Developer ID Application: Enjie Ye (W6D36R8RMG)" --keychain build.keychain --timestamp --verbose "${DMG_PATH}" || {
            echo "ç¬¬ä¸€æ¬¡ç­¾åå°è¯•å¤±è´¥ï¼Œé‡è¯•ä½¿ç”¨è¯¦ç»†æ¨¡å¼..."
            
            # ç¬¬äºŒæ¬¡å°è¯•ï¼Œæ›´è¯¦ç»†çš„è¾“å‡º
            codesign --force --sign "Developer ID Application: Enjie Ye (W6D36R8RMG)" --keychain build.keychain --timestamp --verbose=4 "${DMG_PATH}" || {
              echo "ç­¾åå†æ¬¡å¤±è´¥ï¼Œä½†ä¼šç»§ç»­å¤„ç†..."
            }
          }
          
          echo "æ£€æŸ¥DMGç­¾åçŠ¶æ€..."
          codesign -dvv "${DMG_PATH}" || echo "DMGç­¾åéªŒè¯å¤±è´¥ï¼Œä½†å°†ç»§ç»­å¤„ç†"
          
          echo "dmg_path=${DMG_PATH}" >> $GITHUB_OUTPUT

      - name: Notarize DMG (macOS only)
        if: matrix.platform == 'macos-latest'
        run: |
          echo "å‡†å¤‡å…¬è¯DMGæ–‡ä»¶..."
          if [ ! -f "${{ steps.create_dmg.outputs.dmg_path }}" ]; then
            echo "DMGæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å…¬è¯æ­¥éª¤"
            exit 0
          fi
          
          # æ£€æŸ¥DMGåŸºæœ¬ä¿¡æ¯
          echo "DMGæ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -la "${{ steps.create_dmg.outputs.dmg_path }}"
          file "${{ steps.create_dmg.outputs.dmg_path }}"
          
          # å°è¯•å…¬è¯
          echo "æäº¤å…¬è¯è¯·æ±‚..."
          NOTARIZATION_INFO=$(mktemp)
          
          # ä½¿ç”¨xcrun altoolä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
          if ! xcrun notarytool submit "${{ steps.create_dmg.outputs.dmg_path }}" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_SPECIFIC_PASSWORD }}" \
            --team-id "${{ secrets.TEAM_ID }}" \
            --wait --timeout 1200 > "${NOTARIZATION_INFO}" 2>&1; then
            
            echo "notarytoolå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨altool..."
            xcrun altool --notarize-app \
              --primary-bundle-id "org.openfrp.cpl" \
              --username "${{ secrets.APPLE_ID }}" \
              --password "${{ secrets.APPLE_SPECIFIC_PASSWORD }}" \
              --team-id "${{ secrets.TEAM_ID }}" \
              --file "${{ steps.create_dmg.outputs.dmg_path }}" > "${NOTARIZATION_INFO}" 2>&1 || {
                echo "å…¬è¯å¤±è´¥ï¼Œä½†å°†ç»§ç»­æž„å»º"
                exit 0
              }
          fi
          
          echo "å…¬è¯è¾“å‡ºï¼š"
          cat "${NOTARIZATION_INFO}"
          
          # å³ä½¿å…¬è¯å¤±è´¥ä¹Ÿç»§ç»­å¤„ç†
          echo "å°è¯•æ·»åŠ å…¬è¯æˆ³ç« ..."
          xcrun stapler staple "${{ steps.create_dmg.outputs.dmg_path }}" || echo "æ·»åŠ å…¬è¯æˆ³ç« å¤±è´¥ï¼Œä½†å°†ç»§ç»­æž„å»º"
          
          # éªŒè¯ç»“æžœ
          echo "éªŒè¯ç­¾åå’Œå…¬è¯çŠ¶æ€..."
          xcrun stapler validate "${{ steps.create_dmg.outputs.dmg_path }}" || echo "éªŒè¯å¤±è´¥ï¼Œä½†å°†ç»§ç»­æž„å»º"
          spctl --assess --type open --context context:primary-signature -v "${{ steps.create_dmg.outputs.dmg_path }}" || echo "spctléªŒè¯å¤±è´¥ï¼Œä½†å°†ç»§ç»­æž„å»º"
          
          # ä¸ºå·²ç­¾åå’Œå…¬è¯çš„DMGæ–‡ä»¶é‡å‘½åï¼Œæ·»åŠ signedæ ‡è¯†
          if [ -f "${{ steps.create_dmg.outputs.dmg_path }}" ]; then
            ORIGINAL_DMG_PATH="${{ steps.create_dmg.outputs.dmg_path }}"
            SIGNED_DMG_PATH="${ORIGINAL_DMG_PATH%.dmg}_signed.dmg"
            echo "é‡å‘½åDMGæ–‡ä»¶ï¼Œæ·»åŠ signedæ ‡è¯†..."
            cp "${ORIGINAL_DMG_PATH}" "${SIGNED_DMG_PATH}"
            echo "signed_dmg_path=${SIGNED_DMG_PATH}" >> $GITHUB_OUTPUT
            ls -la "${SIGNED_DMG_PATH}"
          fi

      - name: Upload signed DMG to Release (macOS only)
        if: matrix.platform == 'macos-latest' && startsWith(github.ref, 'refs/tags/')
        run: |
          if [ -f "${{ steps.create_dmg.outputs.dmg_path }}" ]; then
            echo "DMGæ–‡ä»¶å­˜åœ¨ï¼Œå‡†å¤‡ä¸Šä¼ "
            # æ·»åŠ è°ƒè¯•ä¿¡æ¯
            echo "DMGæ–‡ä»¶è·¯å¾„: ${{ steps.create_dmg.outputs.dmg_path }}"
            ls -la "${{ steps.create_dmg.outputs.dmg_path }}"
            
            # ä¿ç•™åŽŸå§‹æ–‡ä»¶åå¹¶æ·»åŠ _signedæ ‡è¯†
            ORIGINAL_DMG_NAME=$(basename "${{ steps.create_dmg.outputs.dmg_path }}")
            SIGNED_DMG_NAME="${ORIGINAL_DMG_NAME%.dmg}_signed.dmg"
            cp "${{ steps.create_dmg.outputs.dmg_path }}" "./${SIGNED_DMG_NAME}"
            
            # ä¸Šä¼ å¸¦signedæ ‡è¯†çš„DMG
            echo "ä¸Šä¼ å¸¦signedæ ‡è¯†çš„DMGæ–‡ä»¶..."
            gh release upload ${{ github.ref_name }} "./${SIGNED_DMG_NAME}" --clobber
          else
            echo "DMGæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ "
          fi
            
            # å¦‚æžœZIPæ–‡ä»¶å­˜åœ¨ï¼Œä¹Ÿä¸Šä¼ 
            if [ -n "${{ steps.create_dmg.outputs.zip_path }}" ] && [ -f "${{ steps.create_dmg.outputs.zip_path }}" ]; then
              echo "ZIPæ–‡ä»¶å­˜åœ¨ï¼Œå‡†å¤‡ä¸Šä¼ "
              gh release upload ${{ github.ref_name }} "${{ steps.create_dmg.outputs.zip_path }}" --clobber || echo "ä¸Šä¼ ZIPå¤±è´¥"
            fi
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload binary files to release
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # æš‚æ—¶ä¸åšè¿™æ­¥ï¼ŒåŽé¢çš„post processå…¶å®žæœ‰
          echo "æš‚æ—¶ä¸åšè¿™æ­¥ï¼ŒåŽé¢çš„post processå…¶å®žæœ‰ðŸ˜‚ã€‚"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  process-updates:
    needs: release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: find artifacts -type f | sort

      - name: Fix AppImage permissions
        run: |
          find artifacts -name "*.AppImage" -type f | while read -r file; do
            chmod +x "$file"
          done

      - name: Upload artifacts to release
        run: |
          echo "ä¸Šä¼ æž„å»ºäº§ç‰©åˆ°GitHub Release..."
          
          # åˆ›å»ºå­˜æ”¾æ–‡ä»¶çš„ä¸´æ—¶ç›®å½•
          mkdir -p release_files
          
          # å¤åˆ¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å’Œç­¾åæ–‡ä»¶
          find artifacts -type f \( -name "*.exe" -o -name "*.msi" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.dmg" -o -name "*.zip" -o -name "*.sig" \) | while read -r file; do
            filename=$(basename "$file")
            echo "å¤„ç†æ–‡ä»¶: $filename"
            cp "$file" "release_files/$filename"
            
            # ä¸ºAppImageæ–‡ä»¶æ·»åŠ å¯æ‰§è¡Œæƒé™
            if [[ "$filename" == *.AppImage ]]; then
              chmod +x "release_files/$filename"
            fi
          done
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ°GitHub Release
          cd release_files
          for file in *; do
            if [ -f "$file" ]; then
              echo "ä¸Šä¼  $file åˆ° GitHub Release"
              gh release upload ${{ github.ref_name }} "$file" --clobber
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create update.json
        run: |
          # èŽ·å–ç‰ˆæœ¬å·(åŽ»æŽ‰vå‰ç¼€)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          
          # åŸºç¡€URL
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}"
          
          # åˆ›å»ºupdate.json
          cat > update.json << EOF
          {
            "version": "$VERSION",
            "notes": "è¯·æŸ¥çœ‹CHANGELOG.mdäº†è§£æ›´æ–°å†…å®¹ã€‚",
            "pub_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "platforms": {
              "windows-x86_64": {
                "signature": "",
                "url": "$BASE_URL/OpenFrp-CrossPlatformLauncher_${VERSION}_x64.msi"
              },
              "windows-aarch64": {
                "signature": "",
                "url": "$BASE_URL/OpenFrp-CrossPlatformLauncher_${VERSION}_arm64.msi"
              },
              "darwin-universal": {
                "signature": "",
                "url": "$BASE_URL/OpenFrp-CrossPlatformLauncher_${VERSION}_universal.dmg"
              },
              "linux-x86_64": {
                "signature": "",
                "url": "$BASE_URL/OpenFrp-CrossPlatformLauncher_${VERSION}_amd64.AppImage"
              }
            }
          }
          EOF
          
          # è¯»å–ç­¾åæ–‡ä»¶å¹¶æ›´æ–°update.json
          echo "æŸ¥æ‰¾ç­¾åæ–‡ä»¶å¹¶æ›´æ–°update.json..."
          
          # Windows x64
          if [ -f "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_x64.msi.sig" ]; then
            WIN64_SIG=$(cat "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_x64.msi.sig")
            sed -i "s|\"windows-x86_64\": {\n.*\"signature\": \"\"|\"windows-x86_64\": {\n        \"signature\": \"$WIN64_SIG\"|" update.json
          fi
          
          # Windows ARM64
          if [ -f "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_arm64.msi.sig" ]; then
            WINARM_SIG=$(cat "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_arm64.msi.sig")
            sed -i "s|\"windows-aarch64\": {\n.*\"signature\": \"\"|\"windows-aarch64\": {\n        \"signature\": \"$WINARM_SIG\"|" update.json
          fi
          
          # macOS
          if [ -f "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_universal.dmg.sig" ]; then
            MAC_SIG=$(cat "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_universal.dmg.sig")
            sed -i "s|\"darwin-universal\": {\n.*\"signature\": \"\"|\"darwin-universal\": {\n        \"signature\": \"$MAC_SIG\"|" update.json
          fi
          
          # Linux
          if [ -f "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_amd64.AppImage.sig" ]; then
            LINUX_SIG=$(cat "release_files/OpenFrp-CrossPlatformLauncher_${VERSION}_amd64.AppImage.sig")
            sed -i "s|\"linux-x86_64\": {\n.*\"signature\": \"\"|\"linux-x86_64\": {\n        \"signature\": \"$LINUX_SIG\"|" update.json
          fi
          
          echo "ç”Ÿæˆçš„update.jsonæ–‡ä»¶å†…å®¹:"
          cat update.json
          
          # ä¸Šä¼ update.jsonåˆ°GitHub Release
          gh release upload ${{ github.ref_name }} update.json --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Write Tauri private key for updater signature
        if: env.TAURI_SIGNING_PRIVATE_KEY != ''
        run: |
          echo "$TAURI_SIGNING_PRIVATE_KEY" > src-tauri/private.key